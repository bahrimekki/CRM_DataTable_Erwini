<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>CRM DataTable Erwini</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
        />
        <link
            href="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-2.0.6/datatables.min.css"
            rel="stylesheet"
        />
    </head>
    <body>
        <h1 class="text-center">CRM DataTable Erwini</h1>
        <div class="container-fluid">
            <div class="row">
                <div class="container">
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-10">
                            <!-- NavBar -->
                            <ul class="nav nav-tabs" id="myTab">
                                <li class="nav-item">
                                    <a
                                        class="nav-link active"
                                        id="steg"
                                        href="#"
                                        onclick="openTable('steg')"
                                        >steg</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        id="connection"
                                        href="#"
                                        onclick="openTable('connection')"
                                        >connection</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        id="alarme"
                                        href="#"
                                        onclick="openTable('alarme')"
                                        >alarme</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        id="control"
                                        href="#"
                                        onclick="openTable('control')"
                                        >control</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        id="command"
                                        href="#"
                                        onclick="openTable('command')"
                                        >command</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        href="#"
                                        id="zone"
                                        onclick="openTable('zone')"
                                        >zone</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        href="#"
                                        id="reonaut"
                                        onclick="openTable('reonaut')"
                                        >reonaut</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        href="#"
                                        id="device"
                                        onclick="openTable('device')"
                                        >device</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        href="#"
                                        id="timePlanning"
                                        onclick="openTable('timePlanning')"
                                        >timePlanning</a
                                    >
                                </li>
                                <li class="nav-item">
                                    <a
                                        class="nav-link"
                                        href="#"
                                        id="users"
                                        onclick="openTable('users')"
                                        >users</a
                                    >
                                </li>
                            </ul>
                            <button class="btn btn-primary">add</button>
                            <div id="container_table"></div>
                        </div>
                        <div class="col-md-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <!-- js libreri -->
    <script
        src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"
    ></script>
    <script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-2.0.6/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.21/dataRender/datetime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- main js function -->
    <script>
        const BASE_URL = "http://localhost:3000/api/administration";
        // const BASE_URL = "https://erwini.herokuapp.com/api/administration";
        const config = {
            headers: { authorization: localStorage.getItem("token") },
        };
        var rows;
        $.getJSON("schemaTables.json", function (data) {
            rows = data;
        }).fail(function () {
            console.log("An error has occurred.");
        });

        const getItems = async (table) => {
            try {
                const response = await axios.post(
                    `${BASE_URL}/get_${table}/`,
                    config
                );
                return response.data;
            } catch (errors) {
                return errors;
            }
        };

        function openTable(table) {
            $("#myTab a").removeClass("active");
            $("#" + table).addClass("active");

            $("#container_table").load(`table.html`);
            Promise.any([getItems(table)]).then((value) => {
                var columnTable = "loading";
                var columnRows = [];
                var dataDataTable = [];
                const columnsDataTable = [];
                var tableColumnHtml = "";
                const FROM_PATTERN = "DD/MM/YYYY HH:mm";
                const TO_PATTERN = "YYYY-MM-DD HH:mm";

                rows.find((o, index) => {
                    o.colunms_tab === table && (columnRows = o.rows);
                });

                if (table === "command") {
                    value.find((o, index) => {
                        dataDataTable.push(o.latestDate);
                    });
                } else {
                    dataDataTable = value;
                }

                columnTable =
                    columnRows.length == 0
                        ? Object.keys(dataDataTable[0])
                        : columnRows;

                dataDataTable = dataDataTable.map((v) => ({
                    ...v,
                    action:
                        "<button class='btn btn-danger' onclick=delet('" +
                        table +
                        "','" +
                        v._id +
                        "')>delet</button><button class='btn btn-info' onclick=alert('edit_id:::" +
                        v._id +
                        "')>edit</button>",
                }));
                if (table === "zone") {
                    dataDataTable = dataDataTable.map((v) => ({
                        ...v,
                        coordinate:
                            '<button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="' +
                            v.coordinate +
                            '">localisation G Map</button>',
                    }));
                }
                if (table === "users") {
                    dataDataTable = dataDataTable.map((v) => ({
                        ...v,
                        password:
                            '<button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="' +
                            v.password +
                            '">password</button>',
                        region:
                            '<button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="' +
                            v.region +
                            '">localisation G Map</button>',
                    }));
                }

                for (i in columnTable) {
                    columnsDataTable.push({ data: columnTable[i] });
                    tableColumnHtml =
                        tableColumnHtml + "<th>" + columnTable[i] + "</th>";
                }
                columnsDataTable.push({ data: "action" });
                tableColumnHtml = tableColumnHtml + "<th>action</th>";

                const target = columnTable.indexOf("datetime");

                console.log("dataDataTable: ", dataDataTable);
                console.log("columnTable_", table, " :", columnTable);
                console.log("columnsDataTable: ", columnsDataTable);

                $("#result").wrapInner(tableColumnHtml);

                new DataTable("#datatable", {
                    // serverSide: true,
                    processing: true,
                    paging: true,
                    columns: columnsDataTable,
                    data: dataDataTable,
                    columnDefs:
                        target == -1
                            ? []
                            : [
                                  {
                                      targets: target,
                                      render: $.fn.dataTable.render.moment(
                                          FROM_PATTERN,
                                          TO_PATTERN
                                      ),
                                  },
                              ],
                    order: [[target == -1 ? 0 : target, "desc"]],
                });
            });
        }
    </script>
</html>
